<div class="pagos-container">
  <!-- ================= HEADER ================= -->
  <div class="page-header">
    <div>
      <h1>Gestión de Pagos</h1>
      <p class="subtitle">Registre cobros y controle la recaudación</p>
    </div>

    <button
      mat-raised-button
      color="primary"
      (click)="abrirFormulario()"
      [disabled]="loading"
    >
      <mat-icon>payments</mat-icon>
      Registrar Pago
    </button>
  </div>

  <!-- ================= BUSCADOR ================= -->
  <mat-card class="search-card">
    <mat-card-content>
      <form
        [formGroup]="searchForm"
        (ngSubmit)="buscar()"
        class="search-row"
      >
        <mat-form-field appearance="outline" class="search-field">
          <mat-label>Buscar</mat-label>
          <input
            matInput
            formControlName="busqueda"
            placeholder="Cliente, crédito, referencia..."
          />
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>

        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="loading"
        >
          Buscar
        </button>

        <button
          mat-stroked-button
          type="button"
          (click)="limpiar()"
          [disabled]="loading"
        >
          Limpiar
        </button>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- ================= FORMULARIO ================= -->
  <mat-card *ngIf="showForm" class="form-card">
    <mat-card-header>
      <mat-card-title>Registrar Pago</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="pagoForm">
        <div class="form-grid">
          <!-- Crédito -->
          <mat-form-field appearance="outline" class="grid-span-2">
            <mat-label>Crédito</mat-label>
            <mat-select formControlName="creditoId" required>
              <mat-option *ngFor="let c of creditos" [value]="c.id">
                {{ labelCredito(c) }}
              </mat-option>
            </mat-select>
            <mat-error
              *ngIf="pagoForm.get('creditoId')?.touched && pagoForm.get('creditoId')?.invalid"
            >
              Seleccione un crédito
            </mat-error>
          </mat-form-field>

          <!-- ✅ Resumen de cuota pendiente (AUTO) -->
          <div class="grid-span-2" *ngIf="pagoForm.get('creditoId')?.value">
            <mat-card class="quota-card" *ngIf="cuotaSeleccionada; else cuotaLoadingOrEmpty">
              <mat-card-content class="quota-content">
                <div class="quota-row">
                  <span class="quota-pill">
                    <mat-icon>receipt_long</mat-icon>
                    Cuota #{{ cuotaSeleccionada.numero }}
                  </span>

                  <span class="quota-pill">
                    <mat-icon>event</mat-icon>
                    Vence: {{ cuotaSeleccionada.fechaVenc | date: 'dd/MM/yyyy' }}
                  </span>

                  <span class="quota-pill strong">
                    <mat-icon>payments</mat-icon>
                    A cobrar: Q {{ cuotaSeleccionada.saldoCuota | number }}
                  </span>
                </div>

                <div class="quota-sub">
                  Regla: <strong>cuota completa</strong>. Monto bloqueado automáticamente.
                </div>
              </mat-card-content>
            </mat-card>

            <ng-template #cuotaLoadingOrEmpty>
              <mat-card class="quota-card">
                <mat-card-content class="quota-content">
                  <div class="quota-row" style="align-items:center; gap:10px;">
                    <mat-spinner *ngIf="loadingCuota" diameter="22"></mat-spinner>
                    <span *ngIf="loadingCuota">Cargando cuota pendiente…</span>

                    <span *ngIf="!loadingCuota">
                      No hay cuota pendiente para este crédito.
                    </span>
                  </div>

                  <div class="quota-sub" *ngIf="!loadingCuota">
                    Seleccione otro crédito o valide el plan de cuotas.
                  </div>
                </mat-card-content>
              </mat-card>
            </ng-template>
          </div>

          <!-- ✅ Monto (bloqueado / cuota exacta) -->
          <mat-form-field appearance="outline">
            <mat-label>Monto (Q)</mat-label>
            <input
              matInput
              type="number"
              formControlName="monto"
              [readonly]="true"
              [disabled]="true"
            />
            <mat-hint>Autocompletado con la cuota pendiente</mat-hint>

            <!-- IMPORTANTE:
                 No mostramos error porque este campo va deshabilitado por diseño.
                 Si usted luego habilita pagos parciales, ahí sí reactivamos validación visual.
            -->
          </mat-form-field>

          <!-- Fecha -->
          <mat-form-field appearance="outline">
            <mat-label>Fecha</mat-label>
            <input matInput type="date" formControlName="fecha" />
            <mat-error
              *ngIf="pagoForm.get('fecha')?.touched && pagoForm.get('fecha')?.invalid"
            >
              Fecha requerida
            </mat-error>
          </mat-form-field>

          <!-- Método -->
          <mat-form-field appearance="outline">
            <mat-label>Método</mat-label>
            <mat-select formControlName="metodo">
              <mat-option value="EFECTIVO">Efectivo</mat-option>
              <mat-option value="TRANSFERENCIA">Transferencia</mat-option>
              <mat-option value="DEPOSITO">Depósito</mat-option>
              <mat-option value="TARJETA">Tarjeta</mat-option>
              <mat-option value="OTRO">Otro</mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Referencia -->
          <mat-form-field appearance="outline">
            <mat-label>Referencia</mat-label>
            <input
              matInput
              formControlName="referencia"
              placeholder="No. boleta / banco / etc."
            />
          </mat-form-field>

          <!-- Observación -->
          <mat-form-field appearance="outline" class="grid-span-2">
            <mat-label>Observación</mat-label>
            <input
              matInput
              formControlName="observacion"
              placeholder="Comentario interno..."
            />
          </mat-form-field>
        </div>

        <!-- Contexto crédito -->
        <div class="context-bar" *ngIf="creditoSeleccionado as cc">
          <span class="ctx">
            <mat-icon>person</mat-icon>
            {{ obtenerNombreCliente(cc.clienteId) }}
          </span>

          <span class="ctx" *ngIf="cc.saldo !== undefined && cc.saldo !== null">
            <mat-icon>account_balance_wallet</mat-icon>
            Saldo: Q {{ cc.saldo | number }}
          </span>

          <span class="ctx" *ngIf="cc.estado">
            <mat-icon>info</mat-icon>
            Estado: {{ cc.estado }}
          </span>
        </div>

        <div class="form-actions">
          <button mat-stroked-button type="button" (click)="cancelarFormulario()">
            Cancelar
          </button>

          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="registrarPago()"
            [disabled]="loading || loadingCuota || pagoForm.invalid || !cuotaSeleccionada"
          >
            Registrar
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- ================= LOADING ================= -->
  <div *ngIf="loading" class="loading-spinner">
    <mat-spinner diameter="48"></mat-spinner>
    <p>Cargando pagos…</p>
  </div>

  <!-- ================= TABLA ================= -->
  <mat-card *ngIf="!loading" class="table-card">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z0">
      <!-- ID -->
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef>#</th>
        <td mat-cell *matCellDef="let p">{{ p.id }}</td>
      </ng-container>

      <!-- Crédito -->
      <ng-container matColumnDef="credito">
        <th mat-header-cell *matHeaderCellDef>Crédito</th>
        <td mat-cell *matCellDef="let p">{{ labelCreditoPago(p) }}</td>
      </ng-container>

      <!-- Cliente -->
      <ng-container matColumnDef="cliente">
        <th mat-header-cell *matHeaderCellDef>Cliente</th>
        <td mat-cell *matCellDef="let p">{{ obtenerClientePago(p) }}</td>
      </ng-container>

      <!-- Monto -->
      <ng-container matColumnDef="monto">
        <th mat-header-cell *matHeaderCellDef>Monto</th>
        <td mat-cell *matCellDef="let p">Q {{ p.monto | number }}</td>
      </ng-container>

      <!-- Fecha -->
      <ng-container matColumnDef="fecha">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let p">{{ p.fecha | date:'dd/MM/yyyy' }}</td>
      </ng-container>

      <!-- Método -->
      <ng-container matColumnDef="metodo">
        <th mat-header-cell *matHeaderCellDef>Método</th>
        <td mat-cell *matCellDef="let p">
          <span [class]="badgeMetodo(p.metodo).cls">
            {{ badgeMetodo(p.metodo).text }}
          </span>
        </td>
      </ng-container>

      <!-- Referencia -->
      <ng-container matColumnDef="referencia">
        <th mat-header-cell *matHeaderCellDef>Ref.</th>
        <td mat-cell *matCellDef="let p">{{ p.referencia || '—' }}</td>
      </ng-container>

      <!-- Acciones -->
      <ng-container matColumnDef="acciones">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let p">
          <button mat-icon-button (click)="verDetalle(p)" matTooltip="Ver detalle">
            <mat-icon>visibility</mat-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator
      [length]="totalRegistros"
      [pageSize]="pageSize"
      [pageSizeOptions]="[5, 10, 25, 50]"
      (page)="onPageChange($event)"
    ></mat-paginator>
  </mat-card>
</div>
